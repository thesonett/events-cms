<div class="bg-white p-6 rounded-lg shadow">
  <!-- Title and Add Post on one line -->
  <div class="flex items-center justify-between mb-1">
    <h3 class="text-lg font-semibold">Manage Posts for <%= eventName %></h3>
    <button onclick="openModal('addPostModal')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      Add Post
    </button>
  </div>

  <!-- Back to events below title -->
  <div class="mb-4">
    <a href="/dashboard/events" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-semibold text-sm">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to events
    </a>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full text-left">
      <thead class="text-gray-600 border-b">
        <tr>
          <th class="py-2 px-4 font-medium">ID</th>
          <th class="py-2 px-4 font-medium">Post Title</th>
          <th class="py-2 px-4 font-medium">Description</th>
          <th class="py-2 px-4 font-medium">Venue</th>
          <th class="py-2 px-4 font-medium">Location</th>
          <th class="py-2 px-4 font-medium">Duration (in hrs)</th>
          <th class="py-2 px-4 font-medium">Organized By</th>
          <th class="py-2 px-4 font-medium">Date</th>
          <th class="py-2 px-4 font-medium">Time</th>
          <th class="py-2 px-4 font-medium">Status</th>
          <th class="py-2 px-4 font-medium">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if(posts && posts.length) { %>
          <% posts.forEach(post => { %>
            <tr class="border-b hover:bg-gray-50">
              <td class="py-2 px-4"><%= post.id %></td>
              <td class="py-2 px-4"><%= post.title %></td>
              <td class="py-2 px-4"><%= post.description %></td>
              <td class="py-2 px-4"><%= post.venue %></td>
              <td class="py-2 px-4"><%= post.location %></td>
              <td class="py-2 px-4"><%= post.duration %> hrs</td>
              <td class="py-2 px-4"><%= post.organizer %></td>
              <td class="py-2 px-4">
                <% const formattedDate = new Date(post.date).toISOString().split('T')[0] %>
                <%= post.date %>
              </td>
              <td class="py-2 px-4">
                <% 
                  const [hours, minutes] = post.time.split(':')
                  const date = new Date()
                  date.setHours(parseInt(hours), parseInt(minutes))
                  const options = { hour: 'numeric', hour12: true }
                  const formattedTime = date.toLocaleTimeString('en-US', options)
                %>
                <%= formattedTime %>
              </td>
              <td class="py-2 px-4">
                <% let statusColor = '' %>
                <% if (post.status === 'upcoming') { statusColor = 'text-blue-600' } %>
                <% if (post.status === 'ongoing') { statusColor = 'text-yellow-600' } %>
                <% if (post.status === 'completed') { statusColor = 'text-green-600' } %>
                <span class="<%= statusColor %> font-semibold capitalize"><%= post.status %></span>
              </td>
              <td class="py-2 px-4 space-x-2">
                <a href="javascript:void(0)" onclick="openModal('editPostModal-<%= post.id %>')" class="text-blue-600 hover:underline">Edit</a>
                <form action="/dashboard/posts/post/delete/<%= post.id %>" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this post?')">
                  <button type="submit" class="text-red-600 hover:underline bg-transparent border-none p-0 cursor-pointer">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="10" class="py-4 px-4 text-center text-gray-500">No posts found</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Post Modal -->
<% if (posts && posts.length) { %>
  <% posts.forEach(post => { %>
    <div id="editPostModal-<%= post.id %>" onclick="handleBackdropClick(event, 'editPostModal-<%= post.id %>')" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative transform transition-all duration-300 scale-95 max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-semibold mb-4">Edit Post</h3>

        <form action="/dashboard/posts/post/update/<%= post.id %>" id="editPostForm-<%= post.id %>" class="space-y-4" method="POST" enctype="multipart/form-data">
          <div>
            <label for="editPostTitle-<%= post.id %>" class="block font-medium mb-1">Title</label>
            <input type="text" id="editPostTitle-<%= post.id %>" name="title" value="<%= post.title %>" required class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label for="editPostDescription-<%= post.id %>" class="block font-medium mb-1">Description</label>
            <textarea id="editPostDescription-<%= post.id %>" name="description" required class="w-full border rounded px-3 py-2"><%= post.description %></textarea>
          </div>

          <div>
            <label for="editPostVenue-<%= post.id %>" class="block font-medium mb-1">Venue</label>
            <input type="text" id="editPostVenue-<%= post.id %>" name="venue" value="<%= post.venue %>" required class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label for="editPostLocation-<%= post.id %>" class="block font-medium mb-1">Location</label>
            <input type="text" id="editPostLocation-<%= post.id %>" name="location" value="<%= post.location %>" required class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label for="editPostDuration-<%= post.id %>" class="block font-medium mb-1">Duration (in hrs)</label>
            <input type="number" id="editPostDuration-<%= post.id %>" name="duration" value="<%= post.duration %>" required class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label for="editPostOrganizedBy-<%= post.id %>" class="block font-medium mb-1">Organized By</label>
            <input type="text" id="editPostOrganizedBy-<%= post.id %>" name="organizedBy" value="<%= post.organizer %>" required class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label for="editPostDate-<%= post.id %>" class="block font-medium mb-1">Date</label>
            <input type="date" id="editPostDate-<%= post.id %>" name="date" value="<%= post.date %>" required class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label for="editPostTime-<%= post.id %>" class="block font-medium mb-1">Time</label>
            <input type="time" id="editPostTime-<%= post.id %>" name="time" value="<%= post.time %>" required class="w-full border rounded px-3 py-2" />
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium mb-1" for="postImage-<%= post.id %>">Post Image</label>
            <input id="postImage-<%= post.id %>" name="images" type="file" multiple accept="image/*" class="w-full border rounded px-3 py-2">
            
            <% if (image_names[post.id] && image_names[post.id].length > 0) { %>
              <% image_names[post.id].forEach((fileName, index) => { %>
                <p class="text-xs mt-1 italic" id="selectedFileName-<%= post.id %>-<%= index %>">Current File: <%= fileName %></p>
              <% }) %>
            <% } %>
          </div>

          <div class="flex justify-end space-x-3 pt-4 border-t">
            <button type="button" onclick="closeModal('editPostModal-<%= post.id %>')" class="px-4 py-2 border rounded hover:bg-gray-100">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Update Post</button>
          </div>
        </form>

        <button onclick="closeModal('editPostModal-<%= post.id %>')" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700" aria-label="Close modal">
          &times;
        </button>
      </div>
    </div>
  <% }) %>
<% } %>


<!-- Add Post Modal -->
<div id="addPostModal" onclick="handleBackdropClick(event, 'addPostModal')" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative transform transition-all duration-300 scale-95 max-h-[90vh] overflow-y-auto">
    <h3 class="text-xl font-semibold mb-4">Add New Post</h3>

    <form action="/dashboard/posts/post/create/<%= eventId %>" id="addPostForm" class="space-y-4" method="POST" enctype="multipart/form-data">
      <div>
        <label for="postTitle" class="block font-medium mb-1">Title</label>
        <input type="text" id="postTitle" name="title" required class="w-full border rounded px-3 py-2" />
      </div>

      <div>
        <label for="postDescription" class="block font-medium mb-1">Description</label>
        <textarea id="postDescription" name="description" required class="w-full border rounded px-3 py-2"></textarea>
      </div>

      <div>
        <label for="postVenue" class="block font-medium mb-1">Venue</label>
        <input type="text" id="postVenue" name="venue" required class="w-full border rounded px-3 py-2" />
      </div>

      <div>
        <label for="postLocation" class="block font-medium mb-1">Location</label>
        <input type="text" id="postLocation" name="location" required class="w-full border rounded px-3 py-2" />
      </div>

      <div>
        <label for="postDuration" class="block font-medium mb-1">Duration (in hrs)</label>
        <input type="number" id="postDuration" name="duration" required class="w-full border rounded px-3 py-2" />
      </div>

      <div>
        <label for="postOrganizedBy" class="block font-medium mb-1">Organized By</label>
        <input type="text" id="postOrganizedBy" name="organizedBy" required class="w-full border rounded px-3 py-2" />
      </div>

      <div>
        <label for="postTime" class="block font-medium mb-1">Time</label>
        <input type="time" id="postTime" name="time" required class="w-full border rounded px-3 py-2" />
      </div>

      <div>
        <label for="postDate" class="block font-medium mb-1">Date</label>
        <input type="date" id="postDate" name="date" required class="w-full border rounded px-3 py-2" />
      </div>

      <div>
        <label for="postImages" class="block font-medium mb-1">Images</label>
        <input type="file" id="postImages" name="images" multiple accept="image/*" class="w-full" />
      </div>

      <div class="flex justify-end space-x-3 pt-4 border-t">
        <button type="button" onclick="closeModal('addPostModal')" class="px-4 py-2 border rounded hover:bg-gray-100">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save Post</button>
      </div>
    </form>

    <button onclick="closeModal('addPostModal')" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700" aria-label="Close modal">
      &times;
    </button>
  </div>
</div>

<script>
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('pointer-events-none', 'opacity-0');
    modal.offsetWidth; // force reflow
    modal.querySelector('div').classList.remove('scale-95');
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.querySelector('div').classList.add('scale-95');
    modal.classList.add('opacity-0');
    setTimeout(() => {
      modal.classList.add('pointer-events-none');
    }, 300);
  }

  function handleBackdropClick(event, modalId) {
    const modalContent = event.currentTarget.querySelector('.transform');
    if (!modalContent.contains(event.target)) {
      closeModal(modalId);
    }
  }
</script>

<% if (notify) { %>
    <script>
      Swal.fire({
        text: "<%- notify %>",
        icon: "info",
        confirmButtonColor: "#ec4899"
      });
    </script>
<% } %>