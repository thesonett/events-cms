<% function formatDate(myDate) {
  const date = new Date(myDate);
  const options = { year: "numeric", month: "long", day: "numeric" };
  return date.toLocaleDateString("en-US", options);
}

function formatTime(timeStr) {
  const [hour, minute] = timeStr.split(":");
  const h = parseInt(hour, 10);
  const ampm = h >= 12 ? "PM" : "AM";
  const hour12 = h % 12 || 12;
  return `${hour12}:${minute} ${ampm}`;
} %>

<div class="bg-gray-100">
  <!-- Hero Section -->
  <div class="relative w-full">
    <img src="<%= image.image_url %>" alt="Image" class="w-full h-64 md:h-96 object-cover" />
    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
      <div class="text-white text-center px-4">
        <h1 class="text-3xl md:text-5xl font-bold font-heading mb-4"><%= event.title %></h1>
        <p class="text-lg md:text-xl max-w-3xl mx-auto mb-1"><%= event.description %></p>
        <p class="text-lg md:text-xl max-w-3xl mx-auto mb-1">Published On <%= event.date.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric", hour: "numeric", minute: "2-digit", hour12: true }) %></p>
        <p class="text-lg md:text-xl max-w-3xl mx-auto mb-1">Published By <%= organizer %></p>
        <p class="text-lg md:text-xl max-w-3xl mx-auto"><%= category.category %></p>
      </div>
    </div>
  </div>

  <!-- Content Section -->
  <div id="events-content" class="flex-grow fade-in">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8 font-heading">Explore <%= event.title %> Events Here!</h2>
      <div class="flex flex-col lg:flex-row gap-8">

        <!-- Sidebar Filters -->
        <aside class="w-full lg:w-1/4 bg-white p-6 rounded-xl shadow-lg lg:sticky lg:top-24 self-start h-fit">
          <h3 class="text-xl font-bold text-gray-800 mb-4 font-heading">Filters</h3>
          <form id="filter-form" method="GET">
            <% const filters = [
              { label: "Venue", data: venues, name: "venue" },
              { label: "Locations", data: locations, name: "location" },
              { label: "Duration", data: durations, name: "duration", suffix: " hrs+" },
              { label: "Date", data: dates, name: "date" },
              { label: "Status", data: statuses, name: "status" },
            ]; %>

            <% filters.forEach(filter => { %>
              <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-2"><%= filter.label %></h4>
                <div class="space-y-2">
                  <% if (filter.data && filter.data.length) { %>
                    <% const selectedValues = [].concat(query[filter.name] || []) %>
                    <% filter.data.forEach(option => { %>
                      <label class="flex items-center">
                        <input
                          type="checkbox"
                          class="mr-2 accent-red-600 custom-checkbox"
                          name="<%= filter.name %>"
                          value="<%= option %>"
                          <%= selectedValues.includes(String(option)) ? "checked" : "" %>
                        />
                        <span><%= option + (filter.suffix || "") %></span>
                      </label>
                    <% }) %>
                  <% } else { %>
                    <label class="flex items-center">
                      <input type="checkbox" class="mr-2 accent-red-600" disabled />
                      <span><%= filter.label %> not available!</span>
                    </label>
                  <% } %>
                </div>
              </div>
            <% }); %>

            <button type="button" id="reset-filters" class="w-full py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
              Reset Filters
            </button>
          </form>
        </aside>

        <!-- Event Cards -->
        <div class="w-full lg:w-3/4">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <% if (postsWithImages && postsWithImages.length) { %>
              <% postsWithImages.forEach(post => { %>
                <a href="/events/posts/post/<%= post.id %>" class="block bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                  <% if (post.images && post.images.length) { %>
                    <img src="<%= post.images[0].image_url %>" alt="Image" class="w-full h-48 object-cover" />
                  <% } else { %>
                    <img src="https://res.cloudinary.com/diobt2ibi/image/upload/v1748862503/undraw_avatars_xsfb_on45bq.jpg" alt="No image available" class="w-full h-48 object-cover" />
                  <% } %>
                  <div class="p-4">
                    <h4 class="text-xl font-bold text-gray-800 font-heading mb-1"><%= post.title %></h4>
                    <p class="text-base font-bold text-gray-600 text-sm"><%= post.description %></p>
                    <p class="text-gray-600 text-sm mt-1"><i class="fas fa-map-marker-alt mr-2 text-red-500"></i><%= post.location %>, <%= post.venue %></p>
                    <p class="text-gray-600 text-sm"><i class="fas fa-calendar-alt mr-2"></i><%= formatDate(post.date) %></p>
                    <p class="text-gray-600 text-sm"><i class="fas fa-clock mr-2"></i>Duration: <%= post.duration %> hrs</p>
                    <p class="text-gray-600 text-sm"><i class="fas fa-clock mr-2"></i>Time: <%= formatTime(post.time) %></p>
                    <p class="text-gray-600 text-sm"><i class="fas fa-user mr-2"></i>Organizer Name: <%= post.organizer %></p>
                    <p class="text-l font-bold mt-2 <%= post.status === 'upcoming' ? 'text-red-600' : post.status === 'ongoing' ? 'text-blue-600' : 'text-green-600' %>"><%= post.status %></p>
                  </div>
                </a>
              <% }) %>
            <% } else { %>
              <p class="text-gray-500 text-center mt-4">No posts available for this event!</p>
            <% } %>
          </div>

          <!-- Pagination -->
          <% if (totalPages > 1) { %>
            <div class="mt-8 flex justify-center space-x-1">
              <% const maxPagesToShow = 3;
                const half = Math.floor(maxPagesToShow / 2);
                let startPage = Math.max(1, pageNo - half);
                let endPage = startPage + maxPagesToShow - 1;
                if (endPage > totalPages) {
                  endPage = totalPages;
                  startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }

                function serializeQuery(obj) {
                  return Object.entries(obj)
                    .map(([key, val]) => {
                      if (Array.isArray(val)) {
                        return val.map(v => `${key}=${encodeURIComponent(v)}`).join("&");
                      }
                      return `${key}=${encodeURIComponent(val)}`;
                    })
                    .join("&");
                }

                const baseQuery = serializeQuery(query);
              %>

              <% if (pageNo > 1) { %>
                <a href="?pageNo=<%= pageNo - 1 %>&<%= baseQuery %>"
                  class="px-2 py-1 text-sm rounded border font-medium bg-white text-gray-800 border-gray-300 hover:bg-gray-100">
                  &lt;
                </a>
              <% } %>

              <% for (let i = startPage; i <= endPage; i++) { %>
                <a href="?pageNo=<%= i %>&<%= baseQuery %>"
                  class="px-3 py-1 text-sm rounded border font-medium transition <%= pageNo === i ? 'bg-red-500 text-white border-red-600' : 'bg-white text-gray-800 border-gray-300 hover:bg-gray-100' %>">
                  <%= i %>
                </a>
              <% } %>

              <% if (pageNo < totalPages) { %>
                <a href="?pageNo=<%= pageNo + 1 %>&<%= baseQuery %>"
                  class="px-2 py-1 text-sm rounded border font-medium bg-white text-gray-800 border-gray-300 hover:bg-gray-100">
                  &gt;
                </a>
              <% } %>
            </div>
          <% } %>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById("reset-filters").addEventListener("click", function () {
    document.querySelectorAll(".custom-checkbox").forEach(cb => cb.checked = false);
    document.getElementById("filter-form").submit();
  });

  document.querySelectorAll(".custom-checkbox").forEach(cb => {
    cb.addEventListener("change", () => {
      document.getElementById("filter-form").submit();
    });
  });
</script>
